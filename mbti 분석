# streamlit_mbti_app.py
# Streamlit app that shows MBTI distribution by country using Plotly
# Save this file as app.py for Streamlit Cloud.
# This file offers a sample dataset and also accepts a user-uploaded CSV.
# Expected CSV format (if you upload): Country,MBTI,Count

import streamlit as st
import pandas as pd
import plotly.express as px
import colorsys

st.set_page_config(page_title="MBTI by Country", layout="wide")

st.title("êµ­ê°€ë³„ MBTI ë¹„ìœ¨ ì‹œê°í™” ğŸ“Š")
st.markdown("ì„ íƒí•œ êµ­ê°€ì˜ MBTI ë¶„í¬ë¥¼ ê¹”ë”í•˜ê³  ì¸í„°ë™í‹°ë¸Œí•œ ë§‰ëŒ€ê·¸ë˜í”„ë¡œ ë³´ì—¬ì¤ë‹ˆë‹¤.")

# --- Sample data (so the app works without upload) ---
SAMPLE = pd.DataFrame([
    ["South Korea","INTJ", 120], ["South Korea","INFP", 95], ["South Korea","ENTP", 75],
    ["South Korea","ESFJ", 60], ["South Korea","ISTJ", 50], ["South Korea","ENFP", 45],
    ["United States","INTJ", 110], ["United States","INFP", 140], ["United States","ENTP", 130],
    ["United States","ESFJ", 85], ["United States","ISTJ", 90], ["United States","ENFP", 70],
    ["Japan","INTJ", 80], ["Japan","INFP", 60], ["Japan","ENTP", 55], ["Japan","ESFJ", 95],
    ["Japan","ISTJ", 120], ["Japan","ENFP", 40]
], columns=["Country","MBTI","Count"])

st.sidebar.header("ë°ì´í„° ì˜µì…˜")
uploaded = st.sidebar.file_uploader("CSV íŒŒì¼ ì—…ë¡œë“œ (Country,MBTI,Count)", type=["csv"]) 
use_sample = st.sidebar.checkbox("ìƒ˜í”Œ ë°ì´í„° ì‚¬ìš© (ì—…ë¡œë“œëœ íŒŒì¼ ìˆë”ë¼ë„)", value=True)

if uploaded is not None and not use_sample:
    try:
        df = pd.read_csv(uploaded)
        if not set(["Country","MBTI","Count"]).issubset(df.columns):
            st.error("CSVì— 'Country', 'MBTI', 'Count' ì»¬ëŸ¼ì´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.")
            st.stop()
    except Exception as e:
        st.error(f"íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜: {e}")
        st.stop()
else:
    df = SAMPLE.copy()

# Ensure types
df = df.copy()
if df['Count'].dtype.kind not in 'iufc':
    df['Count'] = pd.to_numeric(df['Count'], errors='coerce').fillna(0)

countries = sorted(df['Country'].unique())
country = st.selectbox("êµ­ê°€ ì„ íƒ", countries)

# Filter and compute percentages
sub = df[df['Country'] == country].groupby('MBTI', as_index=False)['Count'].sum()
sub = sub.sort_values('Count', ascending=False).reset_index(drop=True)
sub['Percent'] = (sub['Count'] / sub['Count'].sum() * 100).round(2)

# Color logic: 1st = red, rest = blue gradient (ì§„í•´ -> ì˜…ìŒ)
def hls_to_hex(h, l, s):
    r, g, b = colorsys.hls_to_rgb(h, l, s)
    return '#{:02x}{:02x}{:02x}'.format(int(r*255), int(g*255), int(b*255))

colors = []
if len(sub) > 0:
    colors.append('#e63946')  # red for 1st
    n = max(len(sub)-1, 1)
    # generate blue shades from darker to lighter
    for i in range(n):
        t = i / max(n-1, 1)
        # hue for blue ~0.6, vary lightness from 0.35 -> 0.75
        l = 0.35 + 0.4 * (1 - t)  # darker for smaller i
        s = 0.6
        colors.append(hls_to_hex(0.6, l, s))

# Plotly bar
fig = px.bar(sub, x='MBTI', y='Percent', text='Percent', title=f"{country}ì˜ MBTI ë¹„ìœ¨ (ìƒìœ„ë¶€í„°)")
# apply colors in order of bars (sorted by Count desc so first is red)
fig.update_traces(marker_color=colors, hovertemplate='<b>%{x}</b><br>ë¹„ìœ¨: %{y}%<br>ì›ìˆ˜: %{customdata}', customdata=sub['Count'])
fig.update_layout(yaxis_title='ë¹„ìœ¨ (%)', xaxis_title='MBTI', uniformtext_minsize=8, uniformtext_mode='hide')
fig.update_traces(textposition='outside')

st.plotly_chart(fig, use_container_width=True)

# Show table and small explanation
with st.expander("ë°ì´í„° í‘œ ë³´ê¸° / ì„¤ëª… ì—´ê¸°"):
    st.dataframe(sub)
    st.markdown("---")
    st.markdown(
        "**ì„¤ëª…**: ìƒë‹¨ ë§‰ëŒ€ëŠ” í•´ë‹¹ êµ­ê°€ì—ì„œ ê°€ì¥ ë¹„ìœ¨ì´ ë†’ì€ MBTI ìœ í˜•ì…ë‹ˆë‹¤.\n"
        "ë¹¨ê°„ìƒ‰ì€ 1ìœ„ ìœ í˜•ì„ ê°•ì¡°í•˜ê³ , ë‚˜ë¨¸ì§€ëŠ” íŒŒë€ìƒ‰ ê³„ì—´ì˜ ì˜…ì–´ì§€ëŠ” ê·¸ë¼ë°ì´ì…˜ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤."
    )

st.markdown("---")
st.markdown("**ì‚¬ìš© íŒ**: CSV ì—…ë¡œë“œ í›„ ì‚¬ì´ë“œë°”ì—ì„œ 'ìƒ˜í”Œ ë°ì´í„° ì‚¬ìš©' ì²´í¬ë¥¼ í•´ì œí•˜ë©´ ì—…ë¡œë“œí•œ ë°ì´í„°ë¡œ ì‹œê°í™”ë©ë‹ˆë‹¤.")

# Small footer
st.caption("ì•± ê°œë°œì: ChatGPT Â· í•„ìš”í•œ ì¶”ê°€ ê¸°ëŠ¥(ì •ë ¬ ë°©ì‹, ìƒ‰ìƒ ë³€ê²½ ë“±) ìš”ì²­í•´ì£¼ì„¸ìš” ğŸ™‚")

